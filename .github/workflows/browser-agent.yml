name: Browser Agent - Accumulator Bet Finder

on:
  # Run every hour
  schedule:
    - cron: '0 * * * *'
  # Allow manual triggering
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-browser-agent:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Install Playwright browsers
      run: |
        python -m playwright install chromium
        python -m playwright install-deps chromium
    
    - name: Run browser-use agent
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        echo "::group::Agent Execution"
        python browser_agent.py 2>&1 | tee agent_output.log
        echo "::endgroup::"
    
    - name: Generate workflow summary
      if: always()
      run: |
        echo "## Agent Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check if results file exists
        RESULT_FILE=$(find . -maxdepth 1 -name "accumulator_bets_*.json" -type f -mmin -15 | head -1)
        if [ -n "$RESULT_FILE" ]; then
          echo "### âœ… Execution Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Result file:** \`$RESULT_FILE\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Extract key information from JSON
          if command -v jq &> /dev/null; then
            echo "**Search Type:** $(jq -r '.search_type // "N/A"' "$RESULT_FILE")" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Primary Source:** $(jq -r '.primary_source // "N/A"' "$RESULT_FILE")" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Stealth Enabled:** $(jq -r '.stealth_enabled // "N/A"' "$RESULT_FILE")" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            PSYCH_STATE=$(jq -r '.psychological_state.emotional_state // "N/A"' "$RESULT_FILE")
            CONFIDENCE=$(jq -r '.psychological_state.confidence // "N/A"' "$RESULT_FILE")
            echo "**Psychological State:** $PSYCH_STATE (Confidence: $CONFIDENCE)" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "### âŒ Execution Status: FAILED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No result file found. Check logs for errors." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Recent Log Entries" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        tail -n 20 agent_output.log >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No log file available"
        echo '```' >> $GITHUB_STEP_SUMMARY
    
    - name: Commit and push results
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        # Only add JSON result and log files that were just created (within last 15 minutes)
        RESULT_FILES=$(find . -maxdepth 1 \( -name "accumulator_bets_*.json" -o -name "results_*.json" -o -name "agent_log_*.log" \) -type f -mmin -15)
        if [ -n "$RESULT_FILES" ]; then
          echo "$RESULT_FILES" | xargs git add
          git commit -m "Add accumulator bet findings and logs - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          git push
        else
          echo "No result files found to commit"
        fi
